name: Extensions Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      create_github_release:
        description: 'Create GitHub Releases'
        required: false
        default: true
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install semver pipx
        python -m pipx ensurepath
        # jq is pre-installed on ubuntu-latest runners
        
    - name: Discover extensions
      id: discover
      run: |
        # Find all directories with manifest.json
        EXTENSIONS=$(find . -maxdepth 2 -name "manifest.json" -type f | sed 's|./||' | sed 's|/manifest.json||' | sort)
        echo "Found extensions:"
        echo "$EXTENSIONS"
        
        # Convert to JSON array for matrix
        EXTENSIONS_JSON=$(echo "$EXTENSIONS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
        echo "extensions=$EXTENSIONS_JSON" >> $GITHUB_OUTPUT
        
    - name: Bump versions
      id: bump_versions
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        echo "# Version Bumps" > version_summary.txt
        echo "" >> version_summary.txt
        echo "## Changed Extensions" >> version_summary.txt
        echo "" >> version_summary.txt
        
        # Get the last release tag to compare against
        LAST_RELEASE=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_RELEASE" ]; then
          echo "No previous release found, bumping all extensions"
          COMPARE_REF="HEAD~1"  # Compare against previous commit if no tags
        else
          echo "Comparing against last release: $LAST_RELEASE"
          COMPARE_REF="$LAST_RELEASE"
        fi
        
        EXTENSIONS='${{ steps.discover.outputs.extensions }}'
        CHANGED_COUNT=0
        UNCHANGED_COUNT=0
        
        for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
          if [ -f "$extension/manifest.json" ]; then
            # Check if extension directory has changes since last release
            if git diff --quiet "$COMPARE_REF" HEAD -- "$extension/" 2>/dev/null; then
              # No changes - keep current version
              CURRENT_VERSION=$(jq -r '.version' "$extension/manifest.json")
              echo "â­ï¸  $extension: No changes, keeping v${CURRENT_VERSION}"
              echo "${extension}_current=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
              echo "${extension}_new=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
              UNCHANGED_COUNT=$((UNCHANGED_COUNT + 1))
            else
              # Has changes - bump version
              echo "ðŸ“ $extension: Changes detected, bumping version..."
              
              CURRENT_VERSION=$(jq -r '.version' "$extension/manifest.json")
              NEW_VERSION=$(python -c "import semver; v=semver.VersionInfo.parse('${CURRENT_VERSION}'); print(v.bump_${{ github.event.inputs.release_type }}())")
              
              # Update manifest.json with new version
              jq --arg version "${NEW_VERSION}" '.version = $version' "$extension/manifest.json" > "$extension/manifest.json.tmp"
              mv "$extension/manifest.json.tmp" "$extension/manifest.json"
              
              echo "- **$extension**: v${CURRENT_VERSION} â†’ v${NEW_VERSION}" >> version_summary.txt
              echo "${extension}_current=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
              echo "${extension}_new=${NEW_VERSION}" >> $GITHUB_OUTPUT
              
              # Stage the changes
              git add "$extension/manifest.json"
              CHANGED_COUNT=$((CHANGED_COUNT + 1))
            fi
          fi
        done
        
        # Add unchanged extensions section
        if [ $UNCHANGED_COUNT -gt 0 ]; then
          echo "" >> version_summary.txt
          echo "## Unchanged Extensions (${UNCHANGED_COUNT})" >> version_summary.txt
          echo "" >> version_summary.txt
          echo "These extensions have no changes and retain their current versions." >> version_summary.txt
        fi
        
        # Output the summary
        echo "" >> version_summary.txt
        echo "**Summary:** ${CHANGED_COUNT} extensions updated, ${UNCHANGED_COUNT} unchanged" >> version_summary.txt
        cat version_summary.txt
        
        # Store counts for later steps
        echo "changed_count=${CHANGED_COUNT}" >> $GITHUB_OUTPUT
        echo "unchanged_count=${UNCHANGED_COUNT}" >> $GITHUB_OUTPUT
        
    - name: Clone realms framework
      run: |
        git clone https://github.com/smart-social-contracts/realms.git .realms
        
    - name: Install realms CLI
      run: |
        cd .realms
        pipx install -e cli/
        
    - name: Package extensions
      run: |
        mkdir -p releases
        
        EXTENSIONS='${{ steps.discover.outputs.extensions }}'
        
        for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
          echo "Packaging $extension..."
          cd .realms
          realms extension package --extension-id "$extension" --source-dir "../$extension"
          mv "${extension}.zip" "../releases/${extension}.zip"
          cd ..
        done
        
        echo "Packaged extensions:"
        ls -lh releases/
        
    - name: Commit and push version bumps
      id: commit
      run: |
        CHANGED_COUNT="${{ steps.bump_versions.outputs.changed_count }}"
        UNCHANGED_COUNT="${{ steps.bump_versions.outputs.unchanged_count }}"
        
        # Check if there are any changes to commit
        if [ "$CHANGED_COUNT" -eq 0 ]; then
          echo "âš ï¸  No extensions were changed. Skipping commit."
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… $CHANGED_COUNT extension(s) changed. Creating commit..."
          
          COMMIT_MSG="release: Bump $CHANGED_COUNT extension(s) to ${{ github.event.inputs.release_type }} version
          
          $(cat version_summary.txt)"
          
          git commit -m "$COMMIT_MSG"
          
          # Create tags for changed extensions only
          EXTENSIONS='${{ steps.discover.outputs.extensions }}'
          
          for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
            if [ -f "$extension/manifest.json" ]; then
              CURRENT_VERSION=$(jq -r '.version' "$extension/manifest.json")
              TAG_NAME="${extension}-v${CURRENT_VERSION}"
              
              # Only create tag if it doesn't exist
              if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
                git tag -a "$TAG_NAME" -m "${extension} Release v${CURRENT_VERSION}"
                echo "âœ… Created tag $TAG_NAME"
              else
                echo "âš ï¸  Tag $TAG_NAME already exists, skipping"
              fi
            fi
          done
          
          git push origin
          git push origin --tags
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Create GitHub Releases
      if: ${{ github.event.inputs.create_github_release == 'true' }}
      run: |
        EXTENSIONS='${{ steps.discover.outputs.extensions }}'
        
        # Generate release tag with timestamp
        RELEASE_DATE=$(date +%Y-%m-%d)
        RELEASE_TAG="v${RELEASE_DATE}-${{ github.event.inputs.release_type }}"
        
        # Create release body with all extensions
        CHANGED_COUNT="${{ steps.bump_versions.outputs.changed_count }}"
        UNCHANGED_COUNT="${{ steps.bump_versions.outputs.unchanged_count }}"
        
        cat > release_body.md << EOF
        # Realms Extensions Release
        
        This is a ${{ github.event.inputs.release_type }} release with **${CHANGED_COUNT} updated** and **${UNCHANGED_COUNT} unchanged** extensions.
        
        ## âœ¨ Updated Extensions
        
        EOF
        
        # Add changed extensions first
        for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
          if [ -f "$extension/manifest.json" ]; then
            OLD_VERSION="${{ steps.bump_versions.outputs[format('{0}_current', extension)] }}"
            CURRENT_VERSION=$(jq -r '.version' "$extension/manifest.json")
            
            # Only show if version changed (compare with current file version)
            if [ "$OLD_VERSION" != "$CURRENT_VERSION" ]; then
              NAME=$(jq -r '.name' "$extension/manifest.json")
              DESCRIPTION=$(jq -r '.description // "Extension for Realms"' "$extension/manifest.json")
              
              cat >> release_body.md << EXTEOF
        ### ${NAME} (${extension})
        
        **Version:** v${OLD_VERSION} â†’ v${CURRENT_VERSION}
        
        ${DESCRIPTION}
        
        **Installation:**
        \`\`\`bash
        realms extension install ${extension} --from https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${extension}.zip
        \`\`\`
        
        ---
        
        EXTEOF
            fi
          fi
        done
        
        # Add unchanged extensions section
        cat >> release_body.md << 'EOF'
        
        ## ðŸ“¦ Unchanged Extensions
        
        These extensions have no changes since the last release and retain their current versions:
        
        EOF
        
        for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
          if [ -f "$extension/manifest.json" ]; then
            OLD_VERSION="${{ steps.bump_versions.outputs[format('{0}_current', extension)] }}"
            CURRENT_VERSION=$(jq -r '.version' "$extension/manifest.json")
            
            # Only show if version didn't change
            if [ "$OLD_VERSION" = "$CURRENT_VERSION" ]; then
              NAME=$(jq -r '.name' "$extension/manifest.json")
              
              cat >> release_body.md << EXTEOF
        - **${NAME}** (${extension}) - v${CURRENT_VERSION} - [Download](https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${extension}.zip)
        EXTEOF
            fi
          fi
        done
        
        # Add footer
        cat >> release_body.md << 'EOF'
        
        ## ðŸš€ Quick Install All Extensions
        
        To install all extensions at once, download the zip files and use:
        
        \`\`\`bash
        for ext in *.zip; do
          realms extension install "${ext%.zip}" --from "$ext"
        done
        \`\`\`
        
        ## ðŸ“ Changes
        
        This release includes ${{ github.event.inputs.release_type }} version bumps for all extensions.
        
        **Commit:** ${{ github.sha }}
        EOF
        
        # Collect all zip files for the release
        ZIP_FILES=""
        for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
          if [ -f "releases/${extension}.zip" ]; then
            ZIP_FILES="$ZIP_FILES releases/${extension}.zip"
          fi
        done
        
        # Create single release with all extensions
        gh release create "${RELEASE_TAG}" \
          $ZIP_FILES \
          --title "Extensions Release ${RELEASE_DATE} (${{ github.event.inputs.release_type }})" \
          --notes-file release_body.md \
          --repo ${{ github.repository }}
          
        echo "âœ… Created unified release ${RELEASE_TAG} with all extensions"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate release summary
      run: |
        RELEASE_DATE=$(date +%Y-%m-%d)
        RELEASE_TAG="v${RELEASE_DATE}-${{ github.event.inputs.release_type }}"
        CHANGED_COUNT="${{ steps.bump_versions.outputs.changed_count }}"
        UNCHANGED_COUNT="${{ steps.bump_versions.outputs.unchanged_count }}"
        
        echo "## ðŸŽ‰ Extensions Released" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release Tag:** [\`${RELEASE_TAG}\`](https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Summary:** ${CHANGED_COUNT} extensions updated, ${UNCHANGED_COUNT} unchanged" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        EXTENSIONS='${{ steps.discover.outputs.extensions }}'
        
        # Updated extensions
        echo "### âœ¨ Updated Extensions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Extension | Old Version | New Version | Download |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------------|-------------|----------|" >> $GITHUB_STEP_SUMMARY
        
        for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
          if [ -f "$extension/manifest.json" ]; then
            OLD_VERSION="${{ steps.bump_versions.outputs[format('{0}_current', extension)] }}"
            CURRENT_VERSION=$(jq -r '.version' "$extension/manifest.json")
            
            if [ "$OLD_VERSION" != "$CURRENT_VERSION" ]; then
              EXTENSION_NAME=$(jq -r '.name' "$extension/manifest.json")
              echo "| ${EXTENSION_NAME} | v${OLD_VERSION} | v${CURRENT_VERSION} | [${extension}.zip](https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${extension}.zip) |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        # Unchanged extensions
        if [ "$UNCHANGED_COUNT" -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Unchanged Extensions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Extension | Version | Download |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          
          for extension in $(echo "$EXTENSIONS" | jq -r '.[]'); do
            if [ -f "$extension/manifest.json" ]; then
              OLD_VERSION="${{ steps.bump_versions.outputs[format('{0}_current', extension)] }}"
              CURRENT_VERSION=$(jq -r '.version' "$extension/manifest.json")
              
              if [ "$OLD_VERSION" = "$CURRENT_VERSION" ]; then
                EXTENSION_NAME=$(jq -r '.name' "$extension/manifest.json")
                echo "| ${EXTENSION_NAME} | v${CURRENT_VERSION} | [${extension}.zip](https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${extension}.zip) |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Release Type: \`${{ github.event.inputs.release_type }}\`" >> $GITHUB_STEP_SUMMARY
